name: Code Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    name: Generate Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libmbedtls-dev cmake lcov

      - name: Configure with coverage
        run: |
          mkdir -p build_coverage
          cd build_coverage
          cmake -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON ..

      - name: Build with coverage
        run: |
          cd build_coverage
          make -j$(nproc)

      - name: Run tests with coverage
        run: |
          cd build_coverage
          ctest --output-on-failure --verbose || true

      - name: Generate coverage report
        run: |
          cd build_coverage
          # Capture coverage data
          lcov --capture --directory . --output-file coverage.info
          # Remove system headers and test files
          lcov --remove coverage.info '/usr/*' '*/tests/*' '*/build_coverage/*' --output-file coverage.info
          # Generate summary
          lcov --list coverage.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: build_coverage/coverage.info
          flags: unittests
          name: codecov-openfido
          fail_ci_if_error: false
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Generate HTML coverage report
        run: |
          cd build_coverage
          genhtml coverage.info --output-directory coverage_html

      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-html
          path: build_coverage/coverage_html/
          retention-days: 30

      - name: Extract coverage percentage
        id: coverage
        run: |
          cd build_coverage
          COVERAGE=$(lcov --summary coverage.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//')
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = '${{ steps.coverage.outputs.percentage }}';
            const body = `## ðŸ“Š Code Coverage Report
            
            **Coverage**: ${coverage}%
            
            ${coverage >= 80 ? 'âœ…' : coverage >= 70 ? 'âš ï¸' : 'âŒ'} Target: 70%
            
            ðŸ“„ [View detailed HTML report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('Code Coverage Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check coverage threshold
        run: |
          COVERAGE=${{ steps.coverage.outputs.percentage }}
          THRESHOLD=70
          
          echo "Coverage: $COVERAGE%"
          echo "Threshold: $THRESHOLD%"
          
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "âš ï¸  Coverage is below threshold ($THRESHOLD%)"
            echo "This is a warning - please improve test coverage"
          else
            echo "âœ… Coverage meets threshold"
          fi
