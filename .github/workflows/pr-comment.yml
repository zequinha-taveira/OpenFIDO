name: PR Comment

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  comment-build-status:
    name: Comment Build Status
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'Build Summary'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: Get CI Status
        id: ci_status
        run: |
          echo "Getting CI status for PR #${{ github.event.pull_request.number }}"

      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });
            
            const formatCheck = checks.check_runs.find(c => c.name === 'Code Formatting Check');
            const nativeTests = checks.check_runs.find(c => c.name === 'Native Build & Tests');
            const platformBuilds = checks.check_runs.filter(c => c.name.startsWith('PlatformIO Build'));
            
            const statusEmoji = (conclusion) => {
              switch(conclusion) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'âš ï¸';
                default: return 'â³';
              }
            };
            
            let comment = `## ðŸ¤– CI Build Status\n\n`;
            comment += `### Code Quality\n`;
            comment += `${statusEmoji(formatCheck?.conclusion)} **Format Check**: ${formatCheck?.conclusion || 'pending'}\n\n`;
            comment += `### Tests\n`;
            comment += `${statusEmoji(nativeTests?.conclusion)} **Native Tests**: ${nativeTests?.conclusion || 'pending'}\n\n`;
            comment += `### Platform Builds\n`;
            
            for (const build of platformBuilds) {
              const platform = build.name.replace('PlatformIO Build - ', '');
              comment += `${statusEmoji(build.conclusion)} **${platform}**: ${build.conclusion || 'pending'}\n`;
            }
            
            comment += `\n---\n`;
            comment += `ðŸ“Š [View detailed results](${context.payload.pull_request.html_url}/checks)\n`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('CI Build Status')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }
