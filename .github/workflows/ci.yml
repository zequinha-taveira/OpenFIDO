name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Code formatting check
  format-check:
    name: Code Formatting Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format

      - name: Check formatting
        run: |
          find src tests -name '*.c' -o -name '*.h' | xargs clang-format -i --dry-run --Werror

  # Native build and tests
  native-tests:
    name: Native Build & Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libmbedtls-dev

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Debug ..

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure --verbose

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/Testing/

  # PlatformIO builds for embedded platforms
  platformio-build:
    name: PlatformIO Build - ${{ matrix.environment }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        environment:
          - esp32s3
          - esp32s2
          - stm32f4
          - nrf52840
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ matrix.environment }}-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-${{ matrix.environment }}-
            ${{ runner.os }}-pio-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Build firmware
        run: |
          pio run -e ${{ matrix.environment }}

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.environment }}
          path: .pio/build/${{ matrix.environment }}/firmware.*
          retention-days: 30

  # Build summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [format-check, native-tests, platformio-build]
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "Format Check: ${{ needs.format-check.result }}"
          echo "Native Tests: ${{ needs.native-tests.result }}"
          echo "PlatformIO Build: ${{ needs.platformio-build.result }}"
          
          if [ "${{ needs.format-check.result }}" != "success" ] || \
             [ "${{ needs.native-tests.result }}" != "success" ] || \
             [ "${{ needs.platformio-build.result }}" != "success" ]; then
            echo "❌ Some checks failed"
            exit 1
          else
            echo "✅ All checks passed"
          fi
