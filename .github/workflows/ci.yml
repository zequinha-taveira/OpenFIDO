name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Code formatting check
  format-check:
    name: Code Formatting Check
    runs-on: ubuntu-latest
    continue-on-error: true  # Allow auto-format workflow to fix issues
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format

      - name: Check formatting
        run: |
          # Find all C source and header files
          FILES=$(find src tests \( -name '*.c' -o -name '*.h' \) -print)
          if [ -z "$FILES" ]; then
            echo "No C files found to check"
            exit 0
          fi
          echo "Checking formatting for:"
          echo "$FILES"
          echo "$FILES" | xargs clang-format --dry-run --Werror

  # Native build and tests with multiple compilers
  native-tests:
    name: Build & Test - ${{ matrix.compiler }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        mbedtls_version: ['3.5.0']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup compiler
        run: |
          if [ "${{ matrix.compiler }}" = "clang" ]; then
            sudo apt-get update
            sudo apt-get install -y clang
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          else
            echo "CC=gcc" >> $GITHUB_ENV
            echo "CXX=g++" >> $GITHUB_ENV
          fi

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/apt
            build/_deps
          key: ${{ runner.os }}-${{ matrix.compiler }}-deps-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.compiler }}-deps-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libmbedtls-dev

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Debug \
                -DCMAKE_C_COMPILER=$CC \
                -DCMAKE_CXX_COMPILER=$CXX \
                ..

      - name: Build
        run: |
          cd build
          make -j$(nproc) VERBOSE=1

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure --verbose

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.compiler }}
          path: build/Testing/
          retention-days: 7

      - name: Check binary size
        run: |
          if [ -f build/openfido ]; then
            SIZE=$(stat -c%s build/openfido)
            echo "Binary size: $SIZE bytes"
            echo "Binary size: $(numfmt --to=iec-i --suffix=B $SIZE)"
          fi

  # PlatformIO builds for embedded platforms
  platformio-build:
    name: PlatformIO Build - ${{ matrix.environment }}
    runs-on: ubuntu-latest
    continue-on-error: true # Allow failures while project structure is being set up
    strategy:
      fail-fast: false
      matrix:
        environment:
          - esp32s3
          - esp32s2
          - stm32f4
          - nrf52840
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ matrix.environment }}-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-${{ matrix.environment }}-
            ${{ runner.os }}-pio-

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Check PlatformIO version
        run: pio --version

      - name: Build firmware
        run: |
          pio run -e ${{ matrix.environment }} || echo "Build failed - project structure needs adjustment"

      - name: Get firmware size
        if: success()
        run: |
          if [ -f .pio/build/${{ matrix.environment }}/firmware.elf ]; then
            size .pio/build/${{ matrix.environment }}/firmware.elf
          fi

      - name: Upload firmware
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.environment }}
          path: .pio/build/${{ matrix.environment }}/firmware.*
          retention-days: 30

  # Build summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [format-check, native-tests, platformio-build]
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "## ðŸ“Š CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Format Check**: ${{ needs.format-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Native Tests**: ${{ needs.native-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PlatformIO Build**: ${{ needs.platformio-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Only native tests must pass (format will be auto-fixed)
          if [ "${{ needs.native-tests.result }}" != "success" ]; then
            echo "âŒ Native tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Check optional jobs
          if [ "${{ needs.format-check.result }}" == "success" ] && \
             [ "${{ needs.platformio-build.result }}" == "success" ]; then
            echo "âœ… All checks passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.format-check.result }}" != "success" ]; then
            echo "âš ï¸  Format check failed - will be auto-fixed by auto-format workflow" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Core checks passed, PlatformIO builds need attention" >> $GITHUB_STEP_SUMMARY
          fi

